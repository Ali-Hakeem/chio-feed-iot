<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Login - Chio Feed IoT</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background-color: #f5f5f5;
    }

    h2 {
      margin-bottom: 20px;
      color: #333;
    }

    input {
      width: 250px;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    button {
      width: 270px;
      padding: 10px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    button:hover {
      background-color: #0056b3;
    }

    #status {
      margin-top: 20px;
      width: 300px;
      min-height: 50px;
      padding: 10px;
      border-radius: 5px;
      background-color: #fff;
      border: 1px solid #ccc;
      color: #333;
      font-size: 14px;
      white-space: pre-wrap;
    }

    .status-processing { color: #333; }
    .status-success { color: green; }
    .status-error { color: red; }
  </style>
</head>
<body>
  <h2>Login Chio Feeder</h2>
  <input id="username" placeholder="Username" required />
  <input id="password" type="password" placeholder="Password" required />
  <button id="loginBtn">Login</button>
  <pre id="status" class="status-processing"></pre>

  <script>
    const statusEl = document.getElementById('status');

    function setStatus(text, type='processing') {
      statusEl.textContent = text;
      statusEl.className = type === 'success' ? 'status-success'
                         : type === 'error' ? 'status-error'
                         : 'status-processing';
    }

    // =====================
    // Auto logout 4 jam
    // =====================
    function checkAutoLogout() {
      const loginTime = localStorage.getItem('loginTime');
      if (!loginTime) return;
      const now = Date.now();
      const fourHours = 4 * 60 * 60 * 1000; // 4 jam
      if (now - parseInt(loginTime) > fourHours) {
        localStorage.removeItem('username');
        localStorage.removeItem('loginTime');
        alert('‚ö†Ô∏è Sesi sudah lebih dari 4 jam, silakan login ulang');
        window.location.href = '/index.html';
      }
    }

    checkAutoLogout();

    // =====================
    // Event login
    // =====================
    document.getElementById('loginBtn').addEventListener('click', async () => {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      const deviceName = 'WebBrowser';

      if (!username || !password) {
        setStatus('‚ö†Ô∏è Masukkan username & password', 'error');
        return;
      }

      setStatus('üîë Mengecek login...');

      let loginRes;
      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ username, password })
        });
        loginRes = await res.json();
      } catch (e) { setStatus('‚ùå Gagal menghubungi server login', 'error'); return; }

      if (!loginRes.success) {
        setStatus('‚ùå Login gagal!', 'error');
        return;
      }

      setStatus('üìç Login berhasil. Menghubungkan ke server...');

      if (!navigator.geolocation) {
        setStatus('‚ö†Ô∏è Koneksi tidak didukung browser', 'error');
        return;
      }

      navigator.geolocation.getCurrentPosition(async (pos) => {
        setStatus('üìç Mengirim lokasi ke server...');

        const payload = {
          username,
          password,
          deviceName,
          latitude: pos.coords.latitude,
          longitude: pos.coords.longitude,
          hostname: window.location.hostname,
          ts: new Date().toISOString()
        };

        try {
          const res = await fetch('/api/save', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });

          // cek status server
          if (res.status === 403) {
            const errorData = await res.json();
            setStatus(`‚ùå ${errorData.error}`, 'error'); // tampilkan peringatan login 3x/hari
            return;
          }

          const saveRes = await res.json();

          if (saveRes.ok) {
            localStorage.setItem('username', saveRes.user);
            localStorage.setItem('loginTime', Date.now());
            setStatus('‚úÖ Login berhasil!', 'success');
            setTimeout(() => window.location.href = '/dashboard.html', 1000);
          } else {
            setStatus('‚ùå Gagal menyimpan lokasi', 'error');
          }
        } catch(e) {
          setStatus('‚ùå Gagal menghubungi server /api/save', 'error');
        }

      }, () => setStatus('‚ö†Ô∏è Gagal mendapatkan lokasi', 'error'), 
      { enableHighAccuracy: true, timeout: 10000 });
    });
  </script>
</body>
</html>
