<!-- public/index.html -->
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Login - Chio Feed IoT</title>
</head>
<body>
  <h2>Login Admin</h2>
  <input id="username" placeholder="Username" required /><br><br>
  <input id="password" type="password" placeholder="Password" required /><br><br>
  <button id="loginBtn">Login & Save Location</button>
  <pre id="status"></pre>

  <script>
    const statusEl = document.getElementById('status');

    document.getElementById('loginBtn').addEventListener('click', async () => {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      const deviceName = 'WebBrowser'; // Nama device default

      if (!username || !password) {
        statusEl.textContent = '‚ö†Ô∏è Username & password wajib diisi';
        return;
      }

      // 1Ô∏è‚É£ Login dulu
      statusEl.textContent = 'üîë Mengecek login...';
      let loginRes;
      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ username, password })
        });
        const text = await res.text();
        try {
          loginRes = JSON.parse(text);
        } catch {
          statusEl.textContent = '‚ùå Login response tidak valid JSON:\n' + text;
          return;
        }
      } catch (e) {
        statusEl.textContent = '‚ùå Gagal menghubungi server login: ' + e;
        return;
      }

      if (!loginRes.success) {
        statusEl.textContent = '‚ùå Login gagal!';
        return;
      }

      statusEl.textContent = 'üìç Login berhasil. Mengambil lokasi GPS...';

      // 2Ô∏è‚É£ Ambil GPS browser
      if (!navigator.geolocation) {
        statusEl.textContent = '‚ö†Ô∏è Geolocation tidak didukung browser';
        return;
      }

      navigator.geolocation.getCurrentPosition(async (pos) => {
        const latitude = pos.coords.latitude;
        const longitude = pos.coords.longitude;
        statusEl.textContent = `üìç Lokasi ditemukan: ${latitude}, ${longitude}\nMenyimpan ke server...`;

        const payload = {
          username,
          password,
          deviceName,
          latitude,
          longitude,
          hostname: window.location.hostname,
          ts: new Date().toISOString()
        };

        // 3Ô∏è‚É£ Kirim ke /api/save
        try {
          const res = await fetch('/api/save', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });

          const text = await res.text();
          let saveRes;
          try {
            saveRes = JSON.parse(text);
          } catch {
            statusEl.textContent = '‚ùå Response server /api/save bukan JSON:\n' + text;
            return;
          }

          if (saveRes.ok) {
            localStorage.setItem('username', saveRes.user);
            statusEl.textContent = '‚úÖ Login & lokasi tersimpan!\n' + JSON.stringify(saveRes.inserted, null, 2);
            // 4Ô∏è‚É£ Redirect ke dashboard
            window.location.href = '/dashboard.html';
          } else {
            statusEl.textContent = '‚ùå Gagal menyimpan lokasi:\n' + JSON.stringify(saveRes);
          }

        } catch (e) {
          statusEl.textContent = '‚ùå Gagal menghubungi server /api/save: ' + e;
        }

      }, (err) => {
        statusEl.textContent = '‚ö†Ô∏è Gagal mendapatkan lokasi: ' + err.message;
      }, { enableHighAccuracy: true, timeout: 10000 });

    });
  </script>
</body>
</html>
