<!-- public/index.html -->
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Login - Chio Feed IoT</title>
</head>
<body>
  <h2>Login Admin</h2>
  <input id="username" placeholder="Username" required /><br><br>
  <input id="password" type="password" placeholder="Password" required /><br><br>
  <button id="loginBtn">Login & Save Location</button>
  <pre id="status"></pre>

  <script>
    document.getElementById('loginBtn').addEventListener('click', async () => {
      const status = document.getElementById('status');
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const deviceName = 'WebBrowser'; // nama device default

      if (!navigator.geolocation) {
        status.textContent = '‚ö†Ô∏è Geolocation not supported';
        return;
      }

      status.textContent = 'üìç Getting location...';
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        status.textContent = `üìç Got ${lat}, ${lon} ‚Äî saving...`;

        const payload = {
          username,
          password,
          deviceName,
          latitude: lat,
          longitude: lon,
          hostname: window.location.hostname,
          ts: new Date().toISOString()
        };

        try {
          const res = await fetch('/api/savejs', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          const data = await res.json();

          if (data.ok) {
            localStorage.setItem('username', data.user);
            status.textContent = '‚úÖ Login & location saved successfully!\n' + JSON.stringify(data.inserted, null, 2);
            // Redirect ke dashboard
            window.location.href = '/dashboard.html';
          } else {
            status.textContent = '‚ùå Login failed or data invalid: ' + JSON.stringify(data);
          }
        } catch (e) {
          status.textContent = '‚ùå Send error: ' + e;
        }
      }, (err) => {
        status.textContent = '‚ö†Ô∏è Geolocation error: ' + err.message;
      }, { enableHighAccuracy: true, timeout: 10000 });
    });
  </script>
</body>
</html>
